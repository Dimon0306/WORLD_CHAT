<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Chat</title>

    <!-- üîπ PWA: –ú–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Secure Chat">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —á–∞—Ç —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º">

    <!-- üîπ PWA: –ú–∞–Ω–∏—Ñ–µ—Å—Ç –∏ –∏–∫–æ–Ω–∫–∏ -->
    <link rel="manifest" href="{{ url_for('static', path='/manifest.json') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', path='/icons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', path='/icons/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', path='/icons/apple-touch-icon.png') }}">

    <!-- üîπ –®—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">

    <!-- üîπ –°–¢–ò–õ–ò -->
    <style>
        /* === –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA === */
        #pwa-install {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 9999;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
        }
        #pwa-install button {
            background: white;
            color: #667eea;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        #pwa-install.show {
            display: flex;
            align-items: center;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @media (display-mode: standalone) {
            #pwa-install { display: none !important; }
        }

        /* === üåà –†–ê–î–£–ñ–ù–´–ô –§–û–ù –î–õ–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò === */
        body {
            background: #f5f5f5;
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            transition: background 0.5s ease;
        }
        body.chat-page {
            background: linear-gradient(-45deg, 
                #e3f2fd, #f3e5f5, #fff3e0, #e8f5e9);
            background-size: 400% 400%;
            animation: calm-rainbow 20s ease infinite;
        }
        
        body.auth-page {
            background: linear-gradient(-45deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff80, #00ffff, #0080ff, #8000ff, #ff00ff, #ff0080);
            background-size: 400% 400%;
            animation: rainbow-bg 15s ease infinite;
        }
        @keyframes rainbow-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* === ‚ö™ –ù–ï–ô–¢–†–ê–õ–¨–ù–´–ô –§–û–ù –î–õ–Ø –ß–ê–¢–ê === */
        #auth, #chat { display: none; }
        #chat {
            background: #ffffff;  /* –ß–∏—Å—Ç–æ –±–µ–ª—ã–π —Ñ–æ–Ω */
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);  /* –¢–µ–Ω—å –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
            border: 1px solid #e0e0e0;
        }
        #messages {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            scroll-behavior: smooth;
        }
        #messages p {
            background: #ffffff;
            padding: 10px 15px;
            border-radius: 12px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            word-wrap: break-word;
            animation: message-slide 0.3s ease;
        }
        @keyframes message-slide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === –ü–û–õ–ï –í–í–û–î–ê –°–û–û–ë–©–ï–ù–ò–Ø === */
        /* === –ü–û–õ–ï –í–í–û–î–ê ‚Äî –ú–ò–ù–ò === */
        #messageInput {
            width: 65%;
            padding: 8px 14px;
            border: 1px solid #ccc;     /* –¢–æ–Ω—å—à–µ —Ä–∞–º–∫–∞ */
            border-radius: 20px;
            margin-right: 8px;
            font-size: 13px;
            line-height: 1.2;
            min-height: 36px;
            transition: border-color 0.2s;
        }
        #messageInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
        }

        /* === –ö–ù–û–ü–ö–ò –í –ß–ê–¢–ï === */
        #chat button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;        /* –ë—ã–ª–æ 12px 24px ‚Üí –º–µ–Ω—å—à–µ */
        border-radius: 20px;      /* –ë—ã–ª–æ 25px ‚Üí –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;          /* –ú–µ–ª—å—á–µ —Ç–µ–∫—Å—Ç */
        margin: 5px 3px;
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 36px;         /* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—é –≤–≤–æ–¥–∞ */
        }
        #chat button:hover {
            transform: translateY(-1px);  /* –ú–µ–Ω—å—à–µ –∞–Ω–∏–º–∞—Ü–∏—è */
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        /* === –§–û–†–ú–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò === */
        #auth {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            margin: 40px auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        #auth input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        #auth input:focus {
            outline: none;
            border-color: #667eea;
        }
        #auth button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #auth button:hover {
            transform: translateY(-2px);
        }
        #auth h2, #auth h3 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        /* === –ó–ê–ì–û–õ–û–í–û–ö CHAT ROOM === */
        .chat-title {
            font-family: 'Comic Sans MS', 'Poppins', 'Arial', sans-serif;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        .chat-title span {
            display: inline-block;
            background: linear-gradient(45deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff80, #00ffff, #0080ff, #8000ff, #ff00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 900% 100%;
            animation: rainbow 10s linear infinite;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* === –°–ú–ê–ô–õ–´ === */
        .emoji {
            font-size: 18px;
            cursor: pointer;
            user-select: none;
            padding: 5px;
            margin: 2px;
            border-radius: 6px;
            display: inline-block;
        }
        .emoji:hover {
            background-color: #e0e0e0;
        }
        #emojiPanel {
            display: none;
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            border-radius: 4px;
            max-width: 100%;
            overflow-x: auto;
        }

        /* === –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–û–í === */
        .file-upload-section {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .file-upload-section input[type="file"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
        }

        /* === –£–¢–ò–õ–ò–¢–´ === */
        .form-group { margin: 10px 0; }
        .typing-indicator {
            color: #888;
            font-style: italic;
            padding: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h1 class="chat-title">
        <span>C</span><span>h</span><span>a</span><span>t</span>
        <span>R</span><span>o</span><span>o</span><span>m</span>
    </h1>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏) -->
    <div id="chatMessages" style="display:none;"></div>

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="auth">
        <h2>Login / Register</h2>
        <div>
            <h3>Login</h3>
            <div class="form-group">
                <input type="text" id="loginUser" placeholder="Username">
                <input type="password" id="loginPass" placeholder="Password">
                <button onclick="login()">Login</button>
            </div>
        </div>
        <div>
            <h3>Register</h3>
            <div class="form-group">
                <input type="text" id="regUser" placeholder="Username">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPass" placeholder="Password">
                <button onclick="register()">Register</button>
            </div>
        </div>
        <p id="authMessage" style="color:red;"></p>
    </div>

    <!-- –ß–∞—Ç -->
    <div id="chat">
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
        <button onclick="logout()">Logout</button>
        <button onclick="toggleEmojiPanel()" style="font-size: 18px;">üôÇ</button>
        
        <div id="emojiPanel">
            <span class="emoji" onclick="insertEmoji('üòä')">üòä</span>
            <span class="emoji" onclick="insertEmoji('üòÇ')">üòÇ</span>
            <span class="emoji" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span class="emoji" onclick="insertEmoji('üëç')">üëç</span>
            <span class="emoji" onclick="insertEmoji('üî•')">üî•</span>
            <span class="emoji" onclick="insertEmoji('üéâ')">üéâ</span>
            <span class="emoji" onclick="insertEmoji('ü§î')">ü§î</span>
            <span class="emoji" onclick="insertEmoji('üò¢')">üò¢</span>
            <span class="emoji" onclick="insertEmoji('ü•¥')">ü•¥</span>
            <span class="emoji" onclick="insertEmoji('ü•µ')">ü•µ</span>
            <span class="emoji" onclick="insertEmoji('üëå')">üëå</span>
            <span class="emoji" onclick="insertEmoji('üí™')">üí™</span>
            <span class="emoji" onclick="insertEmoji('üòù')">üòù</span>
            <span class="emoji" onclick="insertEmoji('ü§£')">ü§£</span>
            <span class="emoji" onclick="insertEmoji('üëë')">üëë</span>
            <span class="emoji" onclick="insertEmoji('üôÑ')">üôÑ</span>
            <span class="emoji" onclick="insertEmoji('ü§ó')">ü§ó</span>
            <span class="emoji" onclick="insertEmoji('üí©')">üí©</span>
            <span class="emoji" onclick="insertEmoji('üëª')">üëª</span>
            <span class="emoji" onclick="insertEmoji('ü§¢')">ü§¢</span>
            <span class="emoji" onclick="insertEmoji('ü§Æ')">ü§Æ</span>
            <span class="emoji" onclick="insertEmoji('üòë')">üòë</span>
            <span class="emoji" onclick="insertEmoji('ü§Ø')">ü§Ø</span>
            <span class="emoji" onclick="insertEmoji('üòè')">üòè</span>
        </div>
    </div>

    <!-- üîπ PWA: –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
    <div id="pwa-install">
        <span>üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Secure Chat?</span>
        <button id="pwa-install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="pwa-dismiss-btn" style="background:transparent;color:white;margin-left:5px;">‚úï</button>
    </div>

    <!-- üîπ –°–ö–†–ò–ü–¢–´ -->
    <script>
        // === –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ ===
        document.getElementById('uploadForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.'); return; }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    alert('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                    console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                    document.getElementById('uploadForm').reset();
                })
                .catch(err => {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
                    console.error('–û—à–∏–±–∫–∞:', err);
                });
        });

        // === –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ===
        async function loadMessages() {
            const res = await fetch('/messages');
            const msgs = await res.json();
            const container = document.getElementById('chatMessages');
            if (!container) return;
            container.innerHTML = '';
            msgs.forEach(msg => {
                const div = document.createElement('div');
                if (msg.type === 'file') {
                    const url = `/uploads/${msg.content}`;
                    const ext = msg.content.split('.').pop().toLowerCase();
                    if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                        div.innerHTML = `<img src="${url}" style="max-width:200px;max-height:200px;">`;
                    } else {
                        div.innerHTML = `<a href="${url}" target="_blank">üìé ${msg.content}</a>`;
                    }
                } else {
                    div.textContent = msg.content;
                }
                container.appendChild(div);
            });
        }

        // === –ß–∞—Ç: WebSocket –∏ –ª–æ–≥–∏–∫–∞ ===
        let ws = null;
        let token = localStorage.getItem('chat_token');

        function showAuth() {
            document.getElementById('auth').style.display = 'block';
            document.getElementById('chat').style.display = 'none';
            updateBackground();
        }
        function showChat() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('chat').style.display = 'block';
            updateBackground();
        }

        // === üåà –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–¥—É–∂–Ω—ã–º —Ñ–æ–Ω–æ–º ===
        function updateBackground() {
            const auth = document.getElementById('auth');
            const chat = document.getElementById('chat');
            const body = document.body;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–µ–π—á–∞—Å –≤–∏–¥–Ω–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            if (auth?.style.display === 'block') {
                // 1. –ï—Å–ª–∏ –≤–∏–¥–Ω–∞ —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -> –Ø–†–ö–ò–ô —Ñ–æ–Ω
                body.classList.add('auth-page');
                body.classList.remove('chat-page'); // –£–±–∏—Ä–∞–µ–º –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π
                console.log('–§–æ–Ω: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–Ø—Ä–∫–∏–π)');
            } else if (chat?.style.display === 'block') {
                // 2. –ï—Å–ª–∏ –≤–∏–¥–µ–Ω —á–∞—Ç -> –ü–ê–°–¢–ï–õ–¨–ù–´–ô —Ñ–æ–Ω
                body.classList.remove('auth-page'); // –£–±–∏—Ä–∞–µ–º —è—Ä–∫–∏–π
                body.classList.add('chat-page');    // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π!
                console.log('–§–æ–Ω: –ß–∞—Ç (–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π)');
            } else {
                // 3. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ—Ä—ã–π)
                body.classList.remove('auth-page');
                body.classList.remove('chat-page');
            }
        }

        async function register() {
            const user = document.getElementById('regUser').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user, email, password: pass})
            });
            const msgEl = document.getElementById('authMessage');
            if (res.ok) {
                msgEl.textContent = 'Registered! Login now.';
                msgEl.style.color = 'green';
            } else {
                const err = await res.json();
                msgEl.textContent = err.detail || 'Registration failed';
                msgEl.style.color = 'red';
            }
        }

        async function login() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            const formData = new FormData();
            formData.append('username', user);
            formData.append('password', pass);
            
            const res = await fetch('/login', { method: 'POST', body: formData });
            const msgEl = document.getElementById('authMessage');
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem('chat_token', data.access_token);
                token = data.access_token;
                connectWebSocket();
                showChat();
                msgEl.textContent = '';
            } else {
                msgEl.textContent = 'Login failed';
                msgEl.style.color = 'red';
            }
        }

        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${protocol}://${location.host}/ws?token=${token}`);
            
            ws.onmessage = (event) => {
                const messages = document.getElementById('messages');
                const p = document.createElement('p');
                p.textContent = event.data;
                messages.appendChild(p);
                messages.scrollTop = messages.scrollHeight;
            };
            ws.onclose = () => {
                console.log('Disconnected');
                showAuth();
            };
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (msg && ws?.readyState === WebSocket.OPEN) {
                ws.send(msg);
                input.value = '';
            }
        }

        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart ?? input.value.length;
            const end = input.selectionEnd ?? input.value.length;
            input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);
        }

        function logout() {
            ws?.close();
            localStorage.removeItem('chat_token');
            token = null;
            showAuth();
        }

        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            if (token) { connectWebSocket(); showChat(); }
            else { showAuth(); }
            updateBackground();
        });

        // === üîπ PWA: Service Worker –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ===
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(reg => console.log('‚úÖ SW registered:', reg.scope))
                    .catch(err => console.error('‚ùå SW error:', err));
            });
        }

        let deferredPrompt;
        const installBanner = document.getElementById('pwa-install');
        const installBtn = document.getElementById('pwa-install-btn');
        const dismissBtn = document.getElementById('pwa-dismiss-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBanner?.classList.add('show');
        });

        installBtn?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`üì≤ User choice: ${outcome}`);
                deferredPrompt = null;
                installBanner?.classList.remove('show');
            }
        });

        dismissBtn?.addEventListener('click', () => {
            installBanner?.classList.remove('show');
        });

        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed!');
            installBanner?.classList.remove('show');
        });

        document.addEventListener('click', async () => {
            if ('Notification' in window && Notification.permission === 'default') {
                await Notification.requestPermission();
            }
        }, { once: true });
    </script>
</body>
</html>





