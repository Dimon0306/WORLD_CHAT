<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Chat</title>
      <!-- Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹-->
    <title>Chat Room</title>

    <!-- ğŸ”¹ PWA: ĞœĞµÑ‚Ğ°-Ñ‚ĞµĞ³Ğ¸ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Secure Chat">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚ Ñ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼">

<!-- ğŸ”¹ PWA: ĞœĞ°Ğ½Ğ¸Ñ„ĞµÑÑ‚ -->
<link rel="manifest" href="{{ url_for('static', path='/manifest.json') }}">

<!-- ğŸ”¹ PWA: Ğ˜ĞºĞ¾Ğ½ĞºĞ¸ -->
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', path='/icons/favicon-32x32.png') }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', path='/icons/favicon-16x16.png') }}">
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', path='/icons/apple-touch-icon.png') }}">

<!-- ğŸ”¹ PWA: Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ -->
<style>
    /* ĞšĞ½Ğ¾Ğ¿ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ PWA */
    #pwa-install {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 9999;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
    }
    #pwa-install button {
        background: white;
        color: #667eea;
        border: none;
        padding: 6px 16px;
        border-radius: 20px;
        margin-left: 10px;
        cursor: pointer;
        font-weight: bold;
    }
    #pwa-install.show {
        display: flex;
        align-items: center;
        animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    /* Ğ¡ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞµ */
    @media (display-mode: standalone) {
        #pwa-install { display: none !important; }
    }
</style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: Arial; max-width: 1000px; margin: 0 auto; padding: 60px; }
        #auth, #chat { display: none; }
        .form-group { margin: 10px 0; }
        input { width: 70%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 16px; margin: 5px 5px 0 0; }
        #messages { height: 300px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; }

        .emoji {
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            padding: 5px;
            margin: 2px;
            border-radius: 6px;
            display: inline-block;
                }
        .emoji:hover {
            background-color: #e0e0e0;
                }

        .chat-title {
            font-family: 'Comic Sans MS', 'Poppins', 'Arial', sans-serif; /* Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ÑˆÑ€Ğ¸Ñ„Ñ‚ */
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            }

        .chat-title span {
            display: inline-block;
            background: linear-gradient(45deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff80, #00ffff, #0080ff, #8000ff, #ff00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 900% 100%;
            animation: rainbow 10s linear infinite;
            }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
            }

      
    </style>
</head>
<body>
    <h1 class="chat-title">
    <span>C</span><span>h</span><span>a</span><span>t</span>
    <span>R</span><span>o</span><span>o</span><span>m</span>
  </h1>
</body>
</html>

<!--Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°--> 
<!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ â€” Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰Ğ°Ñ‚ÑŒ ĞµĞ³Ğ¾ ĞºÑƒĞ´Ğ° ÑƒĞ³Ğ¾Ğ´Ğ½Ğ¾ -->
<div class="file-upload-section">
  <form id="uploadForm" enctype="multipart/form-data">
    <label for="fileInput">ğŸ“ ĞŸÑ€Ğ¸ĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ»Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾:</label><br><br>
    <input 
      type="file" 
      id="fileInput" 
      name="file" 
      accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.csv"
      required
    ><br><br>
    <button type="submit">ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>
</div>


</style>

<script>
  document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (!file) {
      alert('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ».');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      alert('Ğ¤Ğ°Ğ¹Ğ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½!');
      console.log('ĞÑ‚Ğ²ĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ°:', data);
      // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
      document.getElementById('uploadForm').reset();
    })
    .catch(error => {
      alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ñ„Ğ°Ğ¹Ğ»Ğ°.');
      console.error('ĞÑˆĞ¸Ğ±ĞºĞ°:', error);
    });
  });
</script>

<div id="chatMessages"></div>

<script>
  async function loadMessages() {
    const res = await fetch('/messages');
    const msgs = await res.json();
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';

    msgs.forEach(msg => {
      const div = document.createElement('div');
      if (msg.type === 'file') {
        const url = `/uploads/${msg.content}`;
        const ext = msg.content.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
          div.innerHTML = `<img src="${url}" style="max-width:200px; max-height:200px;">`;
        } else {
          div.innerHTML = `<a href="${url}" target="_blank">ğŸ“ ${msg.content}</a>`;
        }
      } else {
        div.textContent = msg.content;
      }
      container.appendChild(div);
    });
  }

  loadMessages();
  setInterval(loadMessages, 2000);
</script>
<!-- ĞºĞ¾Ğ½ĞµÑ† Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹-->
    <div id="auth">
        <h2>Login / Register</h2>
        <div>
            <h3>Login</h3>
            <div class="form-group">
                <input type="text" id="loginUser" placeholder="Username">
                <input type="password" id="loginPass" placeholder="Password">
                <button onclick="login()">Login</button>
            </div>
        </div>
        <div>
            <h3>Register</h3>
            <div class="form-group">
                <input type="text" id="regUser" placeholder="Username">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPass" placeholder="Password">
                <button onclick="register()">Register</button>
            </div>
        </div>
        <p id="authMessage" style="color:red;"></p>
    </div>

    <div id="chat">
        <!-- Ğ·Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹-->
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
        <!-- ÑĞ¼Ğ°Ğ¹Ğ»Ñ‹-->
        <button onclick="logout()">Logout</button>
        <button onclick="toggleEmojiPanel()" style="margin-top: 5px; font-size: 18px;">ğŸ™‚</button>
        <div id="emojiPanel" style="display:none; margin-top: 8px; padding: 8px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 4px;">
            <span class="emoji" onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</span>
            <span class="emoji" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span>
            <span class="emoji" onclick="insertEmoji('â¤ï¸')">â¤ï¸</span>
            <span class="emoji" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
            <span class="emoji" onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
            <span class="emoji" onclick="insertEmoji('ğŸ‰')">ğŸ‰</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
            <span class="emoji" onclick="insertEmoji('ğŸ˜¢')">ğŸ˜¢</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¥´')">ğŸ¥´</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¥µ')">ğŸ¥µ</span>
            <span class="emoji" onclick="insertEmoji('ğŸ‘Œ')">ğŸ‘Œ</span>
            <span class="emoji" onclick="insertEmoji('ğŸ’ª')">ğŸ’ª</span>
            <span class="emoji" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¤£')">ğŸ¤£</span>
            <span class="emoji" onclick="insertEmoji('ğŸ‘‘')">ğŸ‘‘</span>
            <span class="emoji" onclick="insertEmoji('ğŸ™„')">ğŸ™„</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¤—')">ğŸ¤—</span>
            <span class="emoji" onclick="insertEmoji('ğŸ’©')">ğŸ’©</span>
            <span class="emoji" onclick="insertEmoji('ğŸ‘»')">ğŸ‘»</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¤¢')">ğŸ¤¢</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¤®')">ğŸ¤®</span>
            <span class="emoji" onclick="insertEmoji('ğŸ˜‘')">ğŸ˜‘</span>
            <span class="emoji" onclick="insertEmoji('ğŸ¤¯')">ğŸ¤¯</span>
            <span class="emoji" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span>
        </div>
        </div>

    <script>
        let ws = null;
        let token = localStorage.getItem('chat_token');

        function showAuth() {
            document.getElementById('auth').style.display = 'block';
            document.getElementById('chat').style.display = 'none';
        }


        function showChat() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('chat').style.display = 'block';
        }

        async function register() {
            const user = document.getElementById('regUser').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user, email, password: pass})
            });
            if (res.ok) {
                document.getElementById('authMessage').textContent = 'Registered! Login now.';
            } else {
                const err = await res.json();
                document.getElementById('authMessage').textContent = err.detail || 'Registration failed';
            }
        }

        async function login() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            const formData = new FormData();
            formData.append('username', user);
            formData.append('password', pass);

            const res = await fetch('/login', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem('chat_token', data.access_token);
                token = data.access_token;
                connectWebSocket();
                showChat();
            } else {
                document.getElementById('authMessage').textContent = 'Login failed';
            }
        }

        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${protocol}://${location.host}/ws?token=${token}`);

            ws.onmessage = (event) => {
                const messages = document.getElementById('messages');
                const p = document.createElement('p');
                p.textContent = event.data;
                messages.appendChild(p);
                messages.scrollTop = messages.scrollHeight;
            };

            ws.onclose = () => {
                console.log('Disconnected');
                showAuth();
            };
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (msg && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(msg);
                input.value = '';
            }
        }
            
        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
                
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart || input.value.length;
            const end = input.selectionEnd || input.value.length;
            const before = input.value.substring(0, start);
            const after = input.value.substring(end);
            input.value = before + emoji + after;
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);
            }



        function logout() {
            if (ws) ws.close();
            localStorage.removeItem('chat_token');
            token = null;
            showAuth();
        }

        // ĞŸÑ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
        if (token) {
            connectWebSocket();
            showChat();
        } else {
            showAuth();
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
<!-- ğŸ”¹ PWA: ĞšĞ½Ğ¾Ğ¿ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ -->
<div id="pwa-install">
    <span>ğŸ“± Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Secure Chat?</span>
    <button id="pwa-install-btn">Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
    <button id="pwa-dismiss-btn" style="background:transparent;color:white;margin-left:5px;">âœ•</button>
</div>

<!-- ğŸ”¹ PWA: Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Service Worker -->
<script>
    // Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/static/sw.js')
                .then(reg => console.log('âœ… SW registered:', reg.scope))
                .catch(err => console.error('âŒ SW error:', err));
        });
    }

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ PWA
    let deferredPrompt;
    const installBanner = document.getElementById('pwa-install');
    const installBtn = document.getElementById('pwa-install-btn');
    const dismissBtn = document.getElementById('pwa-dismiss-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBanner.classList.add('show');
        console.log('ğŸ“² PWA install prompt available');
    });

    installBtn?.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`ğŸ“² User choice: ${outcome}`);
            deferredPrompt = null;
            installBanner.classList.remove('show');
        }
    });

    dismissBtn?.addEventListener('click', () => {
        installBanner.classList.remove('show');
    });

    window.addEventListener('appinstalled', () => {
        console.log('âœ… PWA installed!');
        installBanner.classList.remove('show');
    });

    // Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ¸ĞºĞ°
    document.addEventListener('click', async () => {
        if ('Notification' in window && Notification.permission === 'default') {
            await Notification.requestPermission();
        }
    }, { once: true });
</script>
</body>

</html>
