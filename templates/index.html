<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Chat</title>
      <!-- –Ω–∞—á–∞–ª–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã-->
    <title>Chat Room</title>

    <!-- üîπ PWA: –ú–µ—Ç–∞-—Ç–µ–≥–∏ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Secure Chat">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —á–∞—Ç —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º">

<!-- üîπ PWA: –ú–∞–Ω–∏—Ñ–µ—Å—Ç -->
<link rel="manifest" href="{{ url_for('static', path='/manifest.json') }}">

<!-- üîπ PWA: –ò–∫–æ–Ω–∫–∏ -->
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', path='/icons/favicon-32x32.png') }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', path='/icons/favicon-16x16.png') }}">
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', path='/icons/apple-touch-icon.png') }}">

<!-- üîπ PWA: –°—Ç–∏–ª–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
<style>
    /* –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA */
    #pwa-install {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 9999;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
    }
    #pwa-install button {
        background: white;
        color: #667eea;
        border: none;
        padding: 6px 16px;
        border-radius: 20px;
        margin-left: 10px;
        cursor: pointer;
        font-weight: bold;
    }
    #pwa-install.show {
        display: flex;
        align-items: center;
        animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    /* –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ */
    @media (display-mode: standalone) {
        #pwa-install { display: none !important; }
    }
</style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>

        /* === üåà –†–ê–î–£–ñ–ù–´–ô –§–û–ù –î–õ–Ø –ì–õ–ê–í–ù–û–ô –°–¢–†–ê–ù–ò–¶–´ (AUTH) === */
body {
    /* –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —á–∞—Ç–∞ */
    background: #f5f5f5;
    font-family: Arial, sans-serif;
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    transition: background 0.5s ease;
}

/* –†–∞–¥—É–∂–Ω—ã–π —Ñ–æ–Ω —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
body.auth-page {
    background: linear-gradient(-45deg, 
        #ff0000, #ff8000, #ffff00, #80ff00, 
        #00ff80, #00ffff, #0080ff, #8000ff, #ff00ff, #ff0080);
    background-size: 400% 400%;
    animation: rainbow-bg 15s ease infinite;
}

@keyframes rainbow-bg {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* === ‚ö™ –ù–ï–ô–¢–†–ê–õ–¨–ù–´–ô –§–û–ù –î–õ–Ø –ß–ê–¢–ê === */
#chat {
    background: #ffffff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid #e0e0e0;
}

#messages {
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 15px;
    height: 300px;
    overflow-y: auto;
    margin-bottom: 15px;
}

/* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
#messages p {
    background: #ffffff;
    padding: 10px 15px;
    border-radius: 12px;
    margin: 8px 0;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    word-wrap: break-word;
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
#messageInput {
    width: 70%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 25px;
    margin-right: 10px;
    font-size: 14px;
    transition: border-color 0.3s;
}
#messageInput:focus {
    outline: none;
    border-color: #667eea;
}

/* –ö–Ω–æ–ø–∫–∏ –≤ —á–∞—Ç–µ */
#chat button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.2s;
}
#chat button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

/* === üé® –°–¢–ò–õ–ò –î–õ–Ø –§–û–†–ú–´ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò === */
#auth {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    margin: 40px auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

#auth input {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.3s;
}
#auth input:focus {
    outline: none;
    border-color: #667eea;
}

#auth button {
    width: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 10px;
    margin-top: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}
#auth button:hover {
    transform: translateY(-2px);
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ñ–æ—Ä–º */
#auth h2, #auth h3 {
    color: #333;
    text-align: center;
    margin-bottom: 20px;
}

/* === üì± –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ === */
@media (max-width: 600px) {
    body {
        padding: 10px;
    }
    #chat, #auth {
        padding: 15px;
        border-radius: 12px;
    }
    #messageInput {
        width: 100%;
        margin-bottom: 10px;
    }
    #chat button {
        width: 100%;
        margin: 5px 0;
    }
}

/* === üé® –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –≠–§–§–ï–ö–¢–´ === */
/* –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π */
#messages {
    scroll-behavior: smooth;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
#messages p {
    animation: message-slide 0.3s ease;
}
@keyframes message-slide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
.typing-indicator {
    color: #888;
    font-style: italic;
    padding: 10px;
    font-size: 12px;
}
        body { font-family: Arial; max-width: 1000px; margin: 0 auto; padding: 60px; }
        #auth, #chat { display: none; }
        .form-group { margin: 10px 0; }
        input { width: 70%; padding: 8px; margin: 5px 0; }
        button { padding: 8px 16px; margin: 5px 5px 0 0; }
        #messages { height: 300px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; }

        .emoji {
            font-size: 18px;
            cursor: pointer;
            user-select: none;
            padding: 5px;
            margin: 2px;
            border-radius: 6px;
            display: inline-block;
                }
        .emoji:hover {
            background-color: #e0e0e0;
                }

        .chat-title {
            font-family: 'Comic Sans MS', 'Poppins', 'Arial', sans-serif; /* –¥—Ä—É–≥–æ–π —à—Ä–∏—Ñ—Ç */
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            }

        .chat-title span {
            display: inline-block;
            background: linear-gradient(45deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff80, #00ffff, #0080ff, #8000ff, #ff00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 900% 100%;
            animation: rainbow 10s linear infinite;
            }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
            }

      
    </style>
</head>
<body>
    <h1 class="chat-title">
    <span>C</span><span>h</span><span>a</span><span>t</span>
    <span>R</span><span>o</span><span>o</span><span>m</span>
  </h1>
</body>
</html>

<!--–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞--> 
<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ—Ä–º—ã ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –µ–≥–æ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ -->
<div class="file-upload-section">
  <form id="uploadForm" enctype="multipart/form-data">
    <label for="fileInput">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ —Ñ–æ—Ç–æ:</label><br><br>
    <input 
      type="file" 
      id="fileInput" 
      name="file" 
      accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.csv"
      required
    ><br><br>
    <button type="submit">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
</div>


</style>

<script>
  document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (!file) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      alert('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
      console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
      // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
      document.getElementById('uploadForm').reset();
    })
    .catch(error => {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
      console.error('–û—à–∏–±–∫–∞:', error);
    });
  });
</script>

<div id="chatMessages"></div>

<script>
  async function loadMessages() {
    const res = await fetch('/messages');
    const msgs = await res.json();
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';

    msgs.forEach(msg => {
      const div = document.createElement('div');
      if (msg.type === 'file') {
        const url = `/uploads/${msg.content}`;
        const ext = msg.content.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
          div.innerHTML = `<img src="${url}" style="max-width:200px; max-height:200px;">`;
        } else {
          div.innerHTML = `<a href="${url}" target="_blank">üìé ${msg.content}</a>`;
        }
      } else {
        div.textContent = msg.content;
      }
      container.appendChild(div);
    });
  }

  loadMessages();
  setInterval(loadMessages, 2000);
</script>
<!-- –∫–æ–Ω–µ—Ü –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã-->
    <div id="auth">
        <h2>Login / Register</h2>
        <div>
            <h3>Login</h3>
            <div class="form-group">
                <input type="text" id="loginUser" placeholder="Username">
                <input type="password" id="loginPass" placeholder="Password">
                <button onclick="login()">Login</button>
            </div>
        </div>
        <div>
            <h3>Register</h3>
            <div class="form-group">
                <input type="text" id="regUser" placeholder="Username">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPass" placeholder="Password">
                <button onclick="register()">Register</button>
            </div>
        </div>
        <p id="authMessage" style="color:red;"></p>
    </div>

    <div id="chat">
        <!-- –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã-->
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
        <!-- —Å–º–∞–π–ª—ã-->
        <button onclick="logout()">Logout</button>
        <button onclick="toggleEmojiPanel()" style="margin-top: 5px; font-size: 18px;">üôÇ</button>
        <div id="emojiPanel" style="display:none; margin-top: 8px; padding: 8px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 4px;">
            <span class="emoji" onclick="insertEmoji('üòä')">üòä</span>
            <span class="emoji" onclick="insertEmoji('üòÇ')">üòÇ</span>
            <span class="emoji" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span class="emoji" onclick="insertEmoji('üëç')">üëç</span>
            <span class="emoji" onclick="insertEmoji('üî•')">üî•</span>
            <span class="emoji" onclick="insertEmoji('üéâ')">üéâ</span>
            <span class="emoji" onclick="insertEmoji('ü§î')">ü§î</span>
            <span class="emoji" onclick="insertEmoji('üò¢')">üò¢</span>
            <span class="emoji" onclick="insertEmoji('ü•¥')">ü•¥</span>
            <span class="emoji" onclick="insertEmoji('ü•µ')">ü•µ</span>
            <span class="emoji" onclick="insertEmoji('üëå')">üëå</span>
            <span class="emoji" onclick="insertEmoji('üí™')">üí™</span>
            <span class="emoji" onclick="insertEmoji('üòù')">üòù</span>
            <span class="emoji" onclick="insertEmoji('ü§£')">ü§£</span>
            <span class="emoji" onclick="insertEmoji('üëë')">üëë</span>
            <span class="emoji" onclick="insertEmoji('üôÑ')">üôÑ</span>
            <span class="emoji" onclick="insertEmoji('ü§ó')">ü§ó</span>
            <span class="emoji" onclick="insertEmoji('üí©')">üí©</span>
            <span class="emoji" onclick="insertEmoji('üëª')">üëª</span>
            <span class="emoji" onclick="insertEmoji('ü§¢')">ü§¢</span>
            <span class="emoji" onclick="insertEmoji('ü§Æ')">ü§Æ</span>
            <span class="emoji" onclick="insertEmoji('üòë')">üòë</span>
            <span class="emoji" onclick="insertEmoji('ü§Ø')">ü§Ø</span>
            <span class="emoji" onclick="insertEmoji('üòè')">üòè</span>
        </div>
        </div>

    <script>
        let ws = null;
        let token = localStorage.getItem('chat_token');

        function showAuth() {
            document.getElementById('auth').style.display = 'block';
            document.getElementById('chat').style.display = 'none';
        }


        function showChat() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('chat').style.display = 'block';
        }

        async function register() {
            const user = document.getElementById('regUser').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user, email, password: pass})
            });
            if (res.ok) {
                document.getElementById('authMessage').textContent = 'Registered! Login now.';
            } else {
                const err = await res.json();
                document.getElementById('authMessage').textContent = err.detail || 'Registration failed';
            }
        }

        async function login() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            const formData = new FormData();
            formData.append('username', user);
            formData.append('password', pass);

            const res = await fetch('/login', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem('chat_token', data.access_token);
                token = data.access_token;
                connectWebSocket();
                showChat();
            } else {
                document.getElementById('authMessage').textContent = 'Login failed';
            }
        }

        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${protocol}://${location.host}/ws?token=${token}`);

            ws.onmessage = (event) => {
                const messages = document.getElementById('messages');
                const p = document.createElement('p');
                p.textContent = event.data;
                messages.appendChild(p);
                messages.scrollTop = messages.scrollHeight;
            };

            ws.onclose = () => {
                console.log('Disconnected');
                showAuth();
            };
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (msg && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(msg);
                input.value = '';
            }
        }
            
        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
                
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart || input.value.length;
            const end = input.selectionEnd || input.value.length;
            const before = input.value.substring(0, start);
            const after = input.value.substring(end);
            input.value = before + emoji + after;
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);
            }



        function logout() {
            if (ws) ws.close();
            localStorage.removeItem('chat_token');
            token = null;
            showAuth();
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (token) {
            connectWebSocket();
            showChat();
        } else {
            showAuth();
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
<!-- üîπ PWA: –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
<div id="pwa-install">
    <span>üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Secure Chat?</span>
    <button id="pwa-install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button id="pwa-dismiss-btn" style="background:transparent;color:white;margin-left:5px;">‚úï</button>
</div>

<!-- üîπ PWA: –°–∫—Ä–∏–ø—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker -->
<script>
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/static/sw.js')
                .then(reg => console.log('‚úÖ SW registered:', reg.scope))
                .catch(err => console.error('‚ùå SW error:', err));
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA
    let deferredPrompt;
    const installBanner = document.getElementById('pwa-install');
    const installBtn = document.getElementById('pwa-install-btn');
    const dismissBtn = document.getElementById('pwa-dismiss-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBanner.classList.add('show');
        console.log('üì≤ PWA install prompt available');
    });

    installBtn?.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`üì≤ User choice: ${outcome}`);
            deferredPrompt = null;
            installBanner.classList.remove('show');
        }
    });

    dismissBtn?.addEventListener('click', () => {
        installBanner.classList.remove('show');
    });

    window.addEventListener('appinstalled', () => {
        console.log('‚úÖ PWA installed!');
        installBanner.classList.remove('show');
    });

    // –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞
    document.addEventListener('click', async () => {
        if ('Notification' in window && Notification.permission === 'default') {
            await Notification.requestPermission();
        }
    }, { once: true });
</script>
</body>

</html>


